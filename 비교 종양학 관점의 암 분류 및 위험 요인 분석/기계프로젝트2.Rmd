---
title: "기계 프로젝트2"
author: "202201130_hyolim_Kim"
date: "2025-11-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r error=FALSE}

#R 코드: 반려견 림프종 위험 요인 분석 (Phase 2)

# --- 0. 패키지 설치 및 라이브러리 로드 ---

# (아직 설치하지 않았다면)
# install.packages("readxl")       # 엑셀 파일(.xlsx) 읽기용
# install.packages("mice")         # 결측치 대체 (MICE)
# install.packages("rpart")        # 의사결정나무
# install.packages("rpart.plot")   # 의사결정나무 시각화

# (Phase 1에서 설치한 패키지들)
# install.packages("tidyverse")
# install.packages("caret")
# install.packages("randomForest")


library(tidyverse)    # 데이터 전처리 (dplyr, ggplot2)
library(caret)        # 데이터 분리, 모델 평가
library(randomForest) # 랜덤 포레스트
library(rpart)        # 의사결정나무
library(rpart.plot)   # 의사결정나무 시각화

# --- 1. 데이터 불러오기 및 탐색 ---

# 1-1. 엑셀 파일 불러오기
# (파일 이름이 다르면 "..." 부분을 수정하세요)

data_lymphoma <- read.csv("C:/Users/김효림/OneDrive/바탕 화면/통계적기계학습및실습/Ruple_Morley.PLoS_ONE_2016.VMDB_Lymphoma_Case_Control.csv")

# 1-2. 데이터 구조 및 컬럼 이름 확인 (!!필수!!)
# 여기서 나오는 실제 컬럼 이름을 보고, 아래 코드의 변수명을 수정해야 합니다.
str(data_lymphoma)
summary(data_lymphoma)

# (가정) 타겟 변수 'Case_Status', 주요 피처 'Breed', 'Age', 'Weight', 'Sex_Neuter'
# (가정) 'Sex_Neuter' -> 실제로는 'Sex'와 'Neuter_Status' 두 개일 수 있음
# (가정) 환경 변수 -> 'Pesticide_Exposure' (이름이 다를 수 있음)

# 1-3. 타겟 변수(Case_Status) 분포 확인
# (컬럼 이름이 'Case_Status'가 아닐 수 있음)
table(data_lymphoma$Case_Status)

# --- 2. 데이터 전처리 ---

# ---  데이터 전처리 ---

# (이전 단계에서 data_lymphoma는 이미 불러왔다고 가정)
# data_lymphoma <- read.csv("...") 

# 1-1. 분석에 사용할 컬럼만 선택 및 이름 변경
data_processed <- data_lymphoma %>%
  select(
    Case_Status = Case_Control_0.case,  # 타겟 (0=Control, 1=Case)
    Breed_Group = `AKC_GROUP_Mix.0_Sporting.1_Working.2_Herding.3_Hound.4_Toy.5_Nonsport.6_Terrier.7_OtherPurebred.8`,
    Age_Group   = `Agecat_LT1.0_1to2.1_2to4.2_4to7.3_7to10.4_10to15.5_GT15.6`,
    Weight_Group= `WTCAT_0to15.0_15to30.1_30to50.2_50to75.3_75to100.4_100..5_Unk.6`,
    Sex_Group   = `Sex_Status_FI.0_FN.1_MI.2_MN.3_Unk.4`
  )

# 1-2. 'Unk(모름)' 값을 NA(결측치)로 변경
# (Weight_Group 코드 6번, Sex_Group 코드 4번이 'Unk'였음)
data_processed <- data_processed %>%
  mutate(
    Weight_Group = if_else(Weight_Group == 6, NA_integer_, Weight_Group),
    Sex_Group    = if_else(Sex_Group == 4, NA_integer_, Sex_Group)
  )

# 1-3. (!!가장 중요!!) 숫자형 범주를 Factor(범주형)로 변환
# R이 이 숫자들을 연속된 숫자가 아닌 '그룹'으로 인식하게 함
data_processed <- data_processed %>%
  mutate(
    Case_Status = factor(Case_Status, levels = c(0, 1), labels = c("Control", "Case")),
    Breed_Group = factor(Breed_Group, labels = c("Mix", "Sporting", "Working", "Herding", "Hound", "Toy", "Nonsport", "Terrier", "OtherPure")),
    Age_Group   = factor(Age_Group, labels = c("LT1", "1to2", "2to4", "4to7", "7to10", "10to15", "GT15")),
    Weight_Group= factor(Weight_Group, labels = c("0to15", "15to30", "30to50", "50to75", "75to100", "100+")),
    Sex_Group   = factor(Sex_Group, labels = c("FI", "FN", "MI", "MN"))
  )

# 1-4. 결측치 제거
# (로지스틱 회귀, 의사결정나무는 결측치가 있으면 작동 안 함)
data_clean <- data_processed %>%
  na.omit() # Weight_Group, Sex_Group에서 NA가 된 행들을 제거

# 전처리 끝! (데이터 확인)
str(data_clean)
summary(data_clean)


# --- 2. 모델링 ---

# 2-1. Train / Test 데이터 분리 (80:20)
set.seed(123)


# (올바른 라인)
trainIndex_glm <- createDataPartition(data_clean$Case_Status, p = 0.8, list = FALSE) # <--- (O) data_clean을 사용하세요.

# (이후 코드는 그대로 실행)
trainData_glm  <- data_clean[trainIndex_glm, ]
testData_glm   <- data_clean[-trainIndex_glm, ]



# ----------------------------------------------------
# 모델 1 (Logistic Regression - 5주): 핵심 - 위험 요인 해석
# ----------------------------------------------------
# (Control를 기준으로 Case가 될 확률을 모델링)

model_glm <- glm(Case_Status ~ Age_Group + Weight_Group + Breed_Group + Sex_Group, 
                 data = trainData_glm, 
                 family = "binomial")

# 1. p-value 확인: 어떤 변수가 유의미한가?
print("--- 로지스틱 회귀 요약 (p-value 확인) ---")
summary(model_glm)
# (p-value가 0.05보다 작은 변수(예: Age, Breed_GroupGolden_Retriever)가 유의미함)

# 2. 오즈비(Odds Ratio) 계산: 그래서 얼마나 위험한가? (핵심 결과)
print("--- 오즈비 (Odds Ratios) ---")
exp(coef(model_glm))
# (결과 해석 예시)
# Age                      1.4: 나이가 1살 증가할수록, 림프종 발병 위험 1.4배 증가
# Breed_GroupGolden_Retriever 2.7: 'Other' 품종 대비, 골든 리트리버는 위험 2.7배 증가
# Breed_GroupDachshund         0.5: 'Other' 품종 대비, 닥스훈트는 위험 0.5배 (즉, 50% 낮음)


# ----------------------------------------------------
# 모델 2 (Random Forest - 10주): 피처 중요도 확인
# ----------------------------------------------------

model_rf <- randomForest(Case_Status ~ ., 
                         data = trainData_glm) # (na.omit된 데이터 사용)

# 1. 예측 성능 확인 (참고용)

model_rf <- randomForest(Case_Status ~ ., 
                         data = trainData_glm)

pred_rf <- predict(model_rf, testData_glm)
confusionMatrix(pred_rf, testData_glm$Case_Status, positive = "Case")



# 2. 피처 중요도 시각화 (핵심 결과)
print("--- 랜덤 포레스트 피처 중요도 ---")
varImpPlot(model_rf)
# (결과 해석: 어떤 변수가 MeanDecreaseGini가 가장 높은가? = 발병 예측에 가장 중요한가?)


# ----------------------------------------------------
# 모델 3 (Decision Tree - 6주): 고위험군 규칙 시각화
# ----------------------------------------------------
model_tree <- rpart(Case_Status ~ ., 
                    data = trainData_glm)

# 1. 규칙 시각화 (핵심 결과)

print("--- 의사결정나무 규칙 시각화 ---")
rpart.plot(model_tree)
# (결과 해석: 맨 위(Root)에 어떤 변수가 있는가?
#  'Case'로 가는 경로(Rule)는 무엇인가? 
#  예: Breed_Group=Boxer & Age > 8)

# 이 코드는 각 박스에 'Case'와 'Control'의 비율(예: 45%/55%)과 
# 색깔을 명확하게 표시해 줍니다.
rpart.plot(model_tree, 
           extra = 101,              # 비율(%) 표시
           box.palette = "auto",     # Control/Case에 다른 색상 자동 적용
           fallen.leaves = TRUE,     # 맨 아래에 잎 노드 정렬
           main = "Canine Lymphoma Decision Tree")




```